<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector RSVP - Escritorio</title>
    
    <script>
        (function() {
            // Detectar User Agent de dispositivos m√≥viles comunes
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Verificar si el usuario pidi√≥ expl√≠citamente el modo escritorio (?mode=desktop)
            var forceDesktop = window.location.search.indexOf('mode=desktop') > -1;

            // Si es m√≥vil y NO forz√≥ escritorio, redirigir
            if (isMobile && !forceDesktop) {
                window.location.href = "mobile.html";
            }
        })();
    </script>

    <style>
        :root {
            --bg-color: #f4f4f9;
            --box-color: #ffffff;
            --text-color: #333;
            --accent-color: #e63946;
            --border-radius: 8px;
            --primary-color: #2a9d8f;
            --overlay-bg: rgba(255, 255, 255, 0.98);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 { margin-bottom: 1rem; font-size: 1.5rem; }
        
        /* Enlace para cambiar de versi√≥n */
        .version-link {
            position: absolute; top: 1rem; right: 1rem;
            font-size: 0.9rem; color: var(--primary-color);
            text-decoration: none; border-bottom: 1px dashed;
        }

        .input-section {
            width: 100%; max-width: 700px; display: flex; flex-direction: column;
            gap: 15px; margin-bottom: 2rem;
        }

        textarea {
            width: 100%; height: 100px; padding: 10px;
            border: 1px solid #ccc; border-radius: var(--border-radius);
            font-size: 1rem; resize: vertical;
        }

        .controls-container {
            display: flex; flex-wrap: wrap; gap: 15px;
            justify-content: space-between; align-items: center;
            background: #fff; padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .control-group { display: flex; align-items: center; gap: 8px; }

        button {
            padding: 8px 16px; font-size: 0.9rem; cursor: pointer;
            background-color: var(--primary-color); color: white;
            border: none; border-radius: var(--border-radius); transition: background 0.2s;
        }
        button:hover { filter: brightness(90%); }
        button.stop { background-color: #e76f51; }
        button.fullscreen-btn { background-color: #264653; }
        button.context-btn { background-color: #457b9d; }

        label { font-size: 0.9rem; font-weight: 600; }
        input[type="number"] { padding: 5px; width: 60px; border-radius: 4px; border: 1px solid #ccc; }

        /* --- √Årea de Lectura --- */
        #reader-display {
            width: 100%; max-width: 700px; height: 250px;
            background-color: var(--box-color); border-top: 5px solid var(--primary-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: var(--border-radius);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden; outline: none; cursor: pointer;
        }

        #reader-display:fullscreen {
            width: 100vw; height: 100vh; max-width: none; border: none; border-radius: 0; background-color: #fff;
        }

        #reader-display::before, #reader-display::after {
            content: ''; position: absolute; width: 2px; height: 20px;
            background-color: #ddd; left: 50%; transform: translateX(-50%); z-index: 1;
        }
        #reader-display::before { top: 10px; }
        #reader-display::after { bottom: 10px; }
        #reader-display:fullscreen::before { top: 0; height: 40px; }
        #reader-display:fullscreen::after { bottom: 0; height: 40px; }

        .word-container {
            font-family: 'Courier New', Courier, monospace; font-size: 3.5rem;
            font-weight: bold; white-space: pre; display: flex; width: 100%; z-index: 2;
        }
        #reader-display:fullscreen .word-container { font-size: 6rem; }

        .part-left { flex: 1; text-align: right; }
        .part-right { flex: 1; text-align: left; }
        .pivot { color: var(--accent-color); flex: 0 0 auto; }
        .paragraph-symbol { color: #ccc; font-weight: normal; }

        #toast {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 1rem; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 10;
        }
        #toast.show { opacity: 1; }

        #context-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg); z-index: 20; padding: 2rem;
            box-sizing: border-box; overflow-y: auto; display: none;
            font-size: 1.1rem; line-height: 1.6; color: #555; text-align: justify;
        }
        #context-overlay.active { display: block; }

        .ctx-word { cursor: pointer; padding: 2px 1px; border-radius: 3px; margin: 0 2px; display: inline-block; }
        .ctx-word:hover { background-color: #ddd; color: #000; }
        .ctx-word.current { background-color: var(--primary-color); color: white; font-weight: bold; transform: scale(1.1); }
        .ctx-break { display: block; margin-top: 1rem; border-top: 1px dashed #eee; margin-bottom: 0.5rem; }

        .controls-info { font-size: 0.8rem; color: #666; margin-top: 10px; background: #eee; padding: 10px; border-radius: 4px; }
        kbd { background-color: #fff; border: 1px solid #ccc; border-radius: 3px; padding: 2px 5px; font-family: monospace; font-weight: bold; }
    </style>
</head>
<body>

    <a href="mobile.html" class="version-link">Ir a versi√≥n M√≥vil üì±</a>
    <h1>Lector RSVP Escritorio</h1>

    <div class="input-section">
        <textarea id="inputText" placeholder="Pega tu texto con varios p√°rrafos aqu√≠..."></textarea>
        
        <div class="controls-container">
            <div class="control-group">
                <label>WPM:</label>
                <input type="number" id="wpm" value="300" min="60" max="1000" step="25">
            </div>
            <div class="control-group">
                <button id="btnToggle">Iniciar</button>
                <button id="btnReset" class="stop">Reset</button>
                <button id="btnContext" class="context-btn">Ver Texto (V)</button>
                <button id="btnFullscreen" class="fullscreen-btn">Pantalla Completa</button>
            </div>
        </div>

        <div class="controls-info">
            <p>‚å®Ô∏è <b>Controles:</b> <kbd>Espacio</kbd> Play/Pausa | <kbd>‚¨Ü</kbd><kbd>‚¨á</kbd> Velocidad | <kbd>‚¨Ö</kbd><kbd>‚û°</kbd> Saltar | <kbd>Ctrl</kbd>+<kbd>‚¨Ö</kbd> P√°rrafo Anterior</p>
        </div>
    </div>

    <div id="reader-display">
        <div class="word-container" id="wordOutput"></div>
        <div id="toast"></div>
        <div id="context-overlay"></div>
    </div>

    <script>
        const PARAGRAPH_TOKEN = "___PB___";
        let words = [];
        let currentIndex = 0;
        let isPlaying = false;
        let timerOut = null;
        let isContextOpen = false;

        const inputText = document.getElementById('inputText');
        const wordOutput = document.getElementById('wordOutput');
        const btnToggle = document.getElementById('btnToggle');
        const btnReset = document.getElementById('btnReset');
        const btnFullscreen = document.getElementById('btnFullscreen');
        const btnContext = document.getElementById('btnContext');
        const readerDisplay = document.getElementById('reader-display');
        const wpmInput = document.getElementById('wpm');
        const toast = document.getElementById('toast');
        const contextOverlay = document.getElementById('context-overlay');

        window.addEventListener('DOMContentLoaded', () => { renderWord("Listo"); });

        function initData() {
            const rawText = inputText.value.trim();
            if (!rawText) { alert("Por favor ingresa un texto."); return false; }
            const textWithTokens = rawText.replace(/\n+/g, ` ${PARAGRAPH_TOKEN} `);
            words = textWithTokens.split(/\s+/).filter(w => w.length > 0);
            return true;
        }

        function startReader() {
            if (words.length === 0) { if (!initData()) return; }
            if (currentIndex >= words.length) currentIndex = 0;
            isPlaying = true;
            btnToggle.textContent = "Pausa";
            if (isContextOpen) toggleContextView();
            loopReader();
        }

        function loopReader() {
            if (!isPlaying) return;
            if (currentIndex >= words.length) { pauseReader(); currentIndex = 0; return; }

            const currentWord = words[currentIndex];
            renderWord(currentWord);

            const wpm = parseInt(wpmInput.value) || 300;
            const baseDelay = 60000 / wpm;
            let finalDelay = baseDelay;

            if (currentWord === PARAGRAPH_TOKEN) {
                finalDelay = baseDelay * 4.0;
            } else {
                const lastChar = currentWord.slice(-1);
                if (',;'.includes(lastChar)) finalDelay = baseDelay * 2.0; 
                else if ('.?!:‚Äù„ÄÇ'.includes(lastChar)) finalDelay = baseDelay * 3.0;
            }

            currentIndex++;
            timerOut = setTimeout(loopReader, finalDelay);
        }

        function pauseReader() {
            isPlaying = false; clearTimeout(timerOut); btnToggle.textContent = "Continuar";
        }

        function togglePlayPause() {
            if (isContextOpen) { toggleContextView(); startReader(); }
            else { isPlaying ? pauseReader() : startReader(); }
        }

        function resetReader() {
            pauseReader(); currentIndex = 0; words = []; btnToggle.textContent = "Iniciar"; renderWord("Listo");
        }

        function renderWord(rawWord) {
            if (rawWord === PARAGRAPH_TOKEN) {
                wordOutput.innerHTML = `<div class="part-left"></div><div class="pivot paragraph-symbol">¬∂</div><div class="part-right"></div>`; return;
            }
            const regex = /^([^\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú]*)([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\-\']+)([^\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú]*)$/;
            const match = rawWord.match(regex);
            let prefix = "", core = rawWord, suffix = "";
            if (match) { prefix = match[1]; core = match[2]; suffix = match[3]; }

            const len = core.length;
            let left = "", piv = "", right = "";
            if (len < 2) { piv = core; } 
            else if (len % 2 === 0) {
                const mid2 = len / 2; left = core.slice(0, mid2 - 1); piv = core.slice(mid2 - 1, mid2 + 1); right = core.slice(mid2 + 1);
            } else {
                const mid = Math.floor(len / 2); left = core.slice(0, mid); piv = core[mid]; right = core.slice(mid + 1);
            }
            wordOutput.innerHTML = `<div class="part-left">${prefix}${left}</div><div class="pivot">${piv}</div><div class="part-right">${right}${suffix}</div>`;
        }

        let toastTimer;
        function showToast(msg) {
            toast.textContent = msg; toast.classList.add('show'); clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function toggleContextView() {
            if (words.length === 0) { if (!initData()) return; }
            isContextOpen = !isContextOpen;
            if (isContextOpen) {
                pauseReader(); contextOverlay.innerHTML = '';
                words.forEach((word, index) => {
                    if (word === PARAGRAPH_TOKEN) {
                        const br = document.createElement('div'); br.className = 'ctx-break'; contextOverlay.appendChild(br);
                    } else {
                        const span = document.createElement('span'); span.textContent = word + " "; span.className = 'ctx-word';
                        if (index === currentIndex || (index === currentIndex - 1 && currentIndex > 0)) {
                            span.classList.add('current'); setTimeout(() => span.scrollIntoView({block: "center", behavior: "smooth"}), 50);
                        }
                        span.onclick = () => { currentIndex = index; renderWord(words[currentIndex]); showToast("Salto a posici√≥n"); toggleContextView(); };
                        contextOverlay.appendChild(span);
                    }
                });
                contextOverlay.classList.add('active');
            } else { contextOverlay.classList.remove('active'); }
        }

        function changeSpeed(delta) {
            let current = parseInt(wpmInput.value) || 300;
            let newVal = current + delta;
            if (newVal < 60) newVal = 60; wpmInput.value = newVal; showToast(`Velocidad: ${newVal} WPM`);
        }

        function skipWords(direction) {
            if (words.length === 0) return;
            const wpm = parseInt(wpmInput.value) || 300;
            const jumpSize = Math.max(5, Math.floor((wpm / 60) * 2)); 
            const delta = direction === 'left' ? -jumpSize : jumpSize;
            let newIndex = currentIndex + delta;
            if (newIndex < 0) newIndex = 0; if (newIndex >= words.length) newIndex = words.length - 1;
            currentIndex = newIndex; renderWord(words[currentIndex]); showToast(direction === 'left' ? `‚è™ ${jumpSize}` : `‚è© ${jumpSize}`);
        }

        function skipParagraph(direction) {
            if (words.length === 0) return;
            let newIndex = currentIndex;
            if (direction === 'prev') {
                newIndex = Math.max(0, newIndex - 2); 
                while (newIndex > 0 && words[newIndex] !== PARAGRAPH_TOKEN) newIndex--;
                if (words[newIndex] === PARAGRAPH_TOKEN) newIndex++;
            } else {
                while (newIndex < words.length && words[newIndex] !== PARAGRAPH_TOKEN) newIndex++;
                if (newIndex < words.length) newIndex++;
            }
            if (newIndex >= words.length) newIndex = words.length - 1; if (newIndex < 0) newIndex = 0;
            currentIndex = newIndex; renderWord(words[currentIndex]); showToast(direction === 'prev' ? "Inicio P√°rrafo Ant." : "Inicio P√°rrafo Sig.");
        }

        document.addEventListener('keydown', (e) => {
            if (document.activeElement === inputText || document.activeElement === wpmInput) return;
            switch(e.code) {
                case 'Space': e.preventDefault(); togglePlayPause(); break;
                case 'ArrowUp': e.preventDefault(); changeSpeed(25); break;
                case 'ArrowDown': e.preventDefault(); changeSpeed(-25); break;
                case 'ArrowLeft': e.preventDefault(); e.ctrlKey ? skipParagraph('prev') : skipWords('left'); break;
                case 'ArrowRight': e.preventDefault(); e.ctrlKey ? skipParagraph('next') : skipWords('right'); break;
                case 'KeyV': e.preventDefault(); toggleContextView(); break;
            }
        });

        btnToggle.addEventListener('click', togglePlayPause);
        btnReset.addEventListener('click', resetReader);
        btnContext.addEventListener('click', toggleContextView);
        btnFullscreen.addEventListener('click', () => { if (!document.fullscreenElement) { readerDisplay.requestFullscreen().catch(err => alert(err)); } else { document.exitFullscreen(); } });
        readerDisplay.addEventListener('click', (e) => { if (e.target.closest('#context-overlay')) return; togglePlayPause(); });
    </script>
</body>
</html>
